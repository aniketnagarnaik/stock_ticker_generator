<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Data Viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-size: 0.9rem;
        }
        .container {
            margin-top: 10px;
            padding: 0 5px;
        }
        .card {
            margin-bottom: 8px;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .card-header {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }
        .card-body {
            padding: 0.6rem;
        }
        
        /* Mobile-first responsive table */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            overflow-y: visible;
        }
        .table {
            margin-bottom: 0;
            font-size: 0.8rem;
            min-width: 800px; /* Ensure horizontal scroll on mobile */
        }
        .table th {
            background-color: #495057;
            color: white;
            padding: 0.4rem 0.3rem;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .table td {
            padding: 0.3rem;
            vertical-align: middle;
            white-space: nowrap;
        }
        
        /* Column width constraints */
        .company-column {
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .eps-history-column {
            max-width: 200px;
            min-width: 150px;
            font-size: 0.85rem;
            line-height: 1.2;
        }
        .eps-history-column .quarterly-eps {
            display: block;
            margin: 1px 0;
            font-size: 0.8rem;
        }
        
        /* Mobile-specific optimizations */
        @media (max-width: 768px) {
            .container {
                padding: 0 2px;
                margin-top: 5px;
            }
            .card-body {
                padding: 0.4rem;
            }
            .table {
                font-size: 0.75rem;
            }
            .table th {
                padding: 0.3rem 0.2rem;
                font-size: 0.7rem;
            }
            .table td {
                padding: 0.25rem 0.2rem;
            }
            .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
            .form-control, .form-select {
                font-size: 0.8rem;
                padding: 0.25rem 0.4rem;
            }
            
            /* Mobile header optimization */
            .compact-header {
                padding: 10px 0;
            }
            h4 {
                font-size: 1.1rem;
            }
            .timestamp {
                margin-top: 4px;
            }
            .timestamp small {
                font-size: 0.8rem;
                color: #495057 !important;
                font-weight: 500;
            }
            .subtitle-text {
                font-size: 0.85rem;
                color: #495057 !important;
                font-weight: 500;
            }
            .timestamp-text {
                font-size: 0.8rem;
                color: #495057 !important;
                font-weight: 500;
            }
        }
        .stock-row {
            transition: background-color 0.2s;
        }
        .stock-row:hover {
            background-color: #f8f9fa;
        }
        .market-cap {
            font-weight: bold;
        }
        .positive-eps {
            color: #28a745;
            font-weight: 600;
        }
        .negative-eps {
            color: #dc3545;
            font-weight: 600;
        }
        .eps-history {
            font-size: 0.9em;
            line-height: 1.3;
        }
        .eps-history small {
            color: #212529;
            font-weight: 500;
        }
        .eps-value {
            font-weight: 600;
            color: #495057;
        }
        .compact-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 0;
            margin-bottom: 1rem;
        }
        .stats-inline {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
        }
        .filter-compact {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            gap: 6px;
            align-items: center;
            padding: 4px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        .filter-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        .filter-compact .form-control,
        .filter-compact .form-select {
            font-size: 0.75rem;
            padding: 0.2rem 0.4rem;
        }
        
        /* Mobile filter optimization */
        @media (max-width: 768px) {
            .filter-compact {
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
            }
            .filter-group {
                justify-content: space-between;
                padding: 6px;
                gap: 8px;
            }
            .filter-actions {
                justify-content: center;
                margin-top: 5px;
            }
            .filter-compact .form-control,
            .filter-compact .form-select {
                font-size: 0.7rem;
                padding: 0.15rem 0.3rem;
                min-width: 60px;
            }
        }
            .form-check-inline {
                margin-right: 0.5rem;
            }
            .form-check-input {
                margin-right: 0.25rem;
            }
        .btn-sm {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .badge {
            font-size: 0.7rem;
        }
        .timestamp {
            margin-top: 4px;
        }
        .timestamp small {
            font-size: 0.85rem;
            color: #6c757d;
            font-weight: 500;
        }
        .subtitle-text {
            color: #495057 !important;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .timestamp-text {
            color: #495057 !important;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .badge-sm {
            font-size: 0.65rem;
            padding: 0.2rem 0.4rem;
        }
        
        /* EMA Signal Button Styling */
        .ema-signal-btn {
            cursor: pointer !important;
            transition: all 0.2s ease;
            border-width: 2px !important;
            font-weight: 600;
            position: relative;
            border: 2px solid #007bff !important;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
            color: white !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 2px 4px rgba(0,123,255,0.3);
            border-radius: 8px;
        }
        .ema-signal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.5);
            background: linear-gradient(135deg, #0056b3 0%, #004085 100%) !important;
            border-color: #0056b3 !important;
        }
        .ema-signal-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,123,255,0.3);
        }
        .ema-signal-btn::before {
            content: "ðŸ“ˆ ";
            margin-right: 2px;
        }
    </style>
</head>
<body>
    <div class="compact-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-12 text-center">
                    <h4 class="mb-1">ðŸ“ˆ Stock Data Viewer</h4>
                    <div class="timestamp mt-1">
                        <small class="timestamp-text">App version updated: <span id="appVersionTime">{{ server_start_time }}</span></small>
                        {% if cache_status.last_updated %}
                        <br><small class="timestamp-text">Data updated: <span id="cacheTime">{{ cache_status.last_updated }}</span> 
                        <span class="badge bg-{% if cache_status.cache_valid %}success{% else %}warning{% endif %} badge-sm">
                            {% if cache_status.cache_valid %}Fresh{% else %}Stale{% endif %}
                        </span></small>
                        {% endif %}
                </div>
                    <div class="mt-2">
                        <button class="btn btn-light btn-sm" onclick="refreshData()">
                            ðŸ”„ Refresh
                        </button>
                </div>
            </div>
        </div>
                </div>
                </div>

    <div class="container">

        <!-- Multiple Filter -->
        <div class="row mb-2">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0">ðŸ“Š Multiple Filters</h6>
                    </div>
                    <div class="card-body py-2">
                        <div class="filter-compact">
                            <!-- Ticker Filter -->
                            <div class="filter-group">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="tickerCheck">
                                    <label class="form-check-label" for="tickerCheck">Ticker:</label>
                                </div>
                                <input type="text" class="form-control" id="tickerFilter" placeholder="e.g. AAPL, MSFT" style="width: 120px;">
                            </div>

                            <!-- EPS Growth Filter -->
                            <div class="filter-group">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="epsGrowthCheck">
                                    <label class="form-check-label" for="epsGrowthCheck">EPS Growth ></label>
                </div>
                                <select class="form-select" id="epsGrowthThreshold" style="width: auto;">
                                    <option value="25">25%</option>
                                    <option value="35">35%</option>
                                    <option value="custom">Custom</option>
                                </select>
                                <input type="number" class="form-control" id="epsGrowthCustom" placeholder="%" min="-100" max="1000" step="0.1" style="width: 80px; display: none;">
        </div>

                            <!-- RS vs SPY Filter -->
                            <div class="filter-group">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="rsSpyCheck">
                                    <label class="form-check-label" for="rsSpyCheck">RS vs SPY ></label>
                </div>
                                <select class="form-select" id="rsSpyThreshold" style="width: auto;">
                                    <option value="10">10%</option>
                                    <option value="20">20%</option>
                                    <option value="custom">Custom</option>
                                </select>
                                <input type="number" class="form-control" id="rsSpyCustom" placeholder="%" min="-100" max="1000" step="0.1" style="width: 80px; display: none;">
            </div>

                            <!-- RS vs Sector Filter -->
                            <div class="filter-group">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="rsSectorCheck">
                                    <label class="form-check-label" for="rsSectorCheck">RS vs Sector ></label>
                </div>
                                <select class="form-select" id="rsSectorThreshold" style="width: auto;">
                                    <option value="5">5%</option>
                                    <option value="15">15%</option>
                                    <option value="custom">Custom</option>
                                </select>
                                <input type="number" class="form-control" id="rsSectorCustom" placeholder="%" min="-100" max="1000" step="0.1" style="width: 80px; display: none;">
                </div>

                            <!-- EMA Filters - Collapsible Groups -->
                            <div class="filter-group">
                                <div class="accordion" id="emaFiltersAccordion">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="emaFiltersHeader">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#emaFiltersCollapse" aria-expanded="false" aria-controls="emaFiltersCollapse">
                                                ðŸ“Š EMA Filters
                    </button>
                                        </h2>
                                        <div id="emaFiltersCollapse" class="accordion-collapse collapse" aria-labelledby="emaFiltersHeader" data-bs-parent="#emaFiltersAccordion">
                                            <div class="accordion-body">
                                                <!-- Daily EMAs -->
                                                <div class="mb-2">
                                                    <label class="form-label fw-bold">ðŸ“… Daily EMAs:</label>
                                                    <div class="row">
                                                        <div class="col-md-4">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="d9emaCheck">
                                                                <label class="form-check-label" for="d9emaCheck">D_9EMA > Price</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="d21emaCheck">
                                                                <label class="form-check-label" for="d21emaCheck">D_21EMA > Price</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="d50emaCheck">
                                                                <label class="form-check-label" for="d50emaCheck">D_50EMA > Price</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Weekly EMAs -->
                                                <div class="mb-2">
                                                    <label class="form-label fw-bold">ðŸ“† Weekly EMAs:</label>
                                                    <div class="row">
                                                        <div class="col-md-4">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="w9emaCheck">
                                                                <label class="form-check-label" for="w9emaCheck">W_9EMA > Price</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="w21emaCheck">
                                                                <label class="form-check-label" for="w21emaCheck">W_21EMA > Price</label>
                                                            </div>
                </div>
                                                        <div class="col-md-4">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="w50emaCheck">
                                                                <label class="form-check-label" for="w50emaCheck">W_50EMA > Price</label>
                    </div>
                </div>
            </div>
        </div>

                                                <!-- Monthly EMAs -->
                                                <div class="mb-2">
                                                    <label class="form-label fw-bold">ðŸ“… Monthly EMAs:</label>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="m9emaCheck">
                                                                <label class="form-check-label" for="m9emaCheck">M_9EMA > Price</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="m21emaCheck">
                                                                <label class="form-check-label" for="m21emaCheck">M_21EMA > Price</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                </div>
            </div>
                </div>
            </div>

                            <!-- Action Buttons -->
                            <div class="filter-actions">
                                <button class="btn btn-success btn-sm" id="applyMultipleFilterButton">Apply Filters</button>
                                <button class="btn btn-secondary btn-sm" id="clearAllFiltersButton">Clear All</button>
                </div>
            </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stock Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Stock Data</h5>
                    </div>
                    <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                            <th>Symbol</th>
                                <th style="max-width: 120px;">Company</th>
                                            <th>Market Cap</th>
                                            <th>Price</th>
                                        <th>EPS Growth %</th>
                                        <th>RS vs SPY</th>
                                        <th>RS vs Sector</th>
                                        <th>EMA Signal</th>
                                        <th style="min-width: 150px; max-width: 200px;">EPS History</th>
                                <th>Sector</th>
                            </tr>
                        </thead>
                                <tbody>
                                    {% for stock in stocks %}
                                    <tr class="stock-row">
                                        <td><strong>{{ stock.symbol }}</strong></td>
                                        <td class="company-column">{{ stock.company_name }}</td>
                                        <td class="market-cap">{{ stock.market_cap|format_market_cap }}</td>
                                        <td>${{ "%.2f"|format(stock.price) }}</td>
                                        <td class="{% if stock.eps_growth and stock.eps_growth.quarter_over_quarter and stock.eps_growth.quarter_over_quarter > 0 %}positive-eps{% elif stock.eps_growth and stock.eps_growth.quarter_over_quarter and stock.eps_growth.quarter_over_quarter < 0 %}negative-eps{% endif %}">
                                            {% if stock.eps_growth and stock.eps_growth.quarter_over_quarter is not none %}
                                                {{ "%.1f"|format(stock.eps_growth.quarter_over_quarter) }}%
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td class="{% if stock.relative_strength and stock.relative_strength.rs_spy and stock.relative_strength.rs_spy > 0 %}positive-eps{% elif stock.relative_strength and stock.relative_strength.rs_spy and stock.relative_strength.rs_spy < 0 %}negative-eps{% endif %}">
                                            {% if stock.relative_strength and stock.relative_strength.rs_spy is not none %}
                                                {{ "%.1f"|format(stock.relative_strength.rs_spy) }}%
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td class="{% if stock.relative_strength and stock.relative_strength.rs_sector and stock.relative_strength.rs_sector > 0 %}positive-eps{% elif stock.relative_strength and stock.relative_strength.rs_sector and stock.relative_strength.rs_sector < 0 %}negative-eps{% endif %}">
                                            {% if stock.relative_strength and stock.relative_strength.rs_sector is not none %}
                                                {{ "%.1f"|format(stock.relative_strength.rs_sector) }}%
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-info ema-signal-btn" onclick="showEmaDetails('{{ stock.symbol }}')" title="ðŸ“Š Click to view detailed EMA analysis" style="cursor: pointer;">
                                                {% if stock.ema_data %}
                                                    {% set above_count = 0 %}
                                                    {% set below_count = 0 %}
                                                    {% set total_valid_emas = 0 %}
                                                    {% for ema_key, ema_value in stock.ema_data.items() %}
                                                        {% if ema_value is not none %}
                                                            {% set total_valid_emas = total_valid_emas + 1 %}
                                                            {% if stock.price > ema_value %}
                                                                {% set above_count = above_count + 1 %}
                                                            {% else %}
                                                                {% set below_count = below_count + 1 %}
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                    {% if total_valid_emas > 0 %}
                                                        {% if above_count == total_valid_emas %}
                                                            ðŸŸ¢ Bullish
                                                        {% elif below_count == total_valid_emas %}
                                                            ðŸ”´ Bearish
                                                        {% else %}
                                                            ðŸŸ¡ Mixed
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="text-muted">N/A</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">N/A</span>
                                                {% endif %}
                                            </button>
                                        </td>
                                        <td class="eps-history-column">
                                            {% if stock.eps_history and stock.eps_history.quarterly %}
                                                <div class="eps-history">
                                                    {% for quarter_date, eps in stock.eps_history.quarterly.items() %}
                                                        <small class="d-block">
                                                            {% set year = quarter_date[:4] %}
                                                            {% set month = quarter_date[5:7] %}
                                                            {% if month == "01" or month == "02" or month == "03" %}
                                                                Q1 {{ year }}: <span class="eps-value">${{ "%.2f"|format(eps) }}</span>
                                                            {% elif month == "04" or month == "05" or month == "06" %}
                                                                Q2 {{ year }}: <span class="eps-value">${{ "%.2f"|format(eps) }}</span>
                                                            {% elif month == "07" or month == "08" or month == "09" %}
                                                                Q3 {{ year }}: <span class="eps-value">${{ "%.2f"|format(eps) }}</span>
                                                            {% else %}
                                                                Q4 {{ year }}: <span class="eps-value">${{ "%.2f"|format(eps) }}</span>
                                                            {% endif %}
                                                        </small>
                                                    {% endfor %}
                                                </div>
                                            {% else %}
                                                <small class="text-muted">N/A</small>
                                            {% endif %}
                                        </td>
                                        <td><span class="badge bg-secondary">{{ stock.sector }}</span></td>
                                    </tr>
                                    {% endfor %}
                        </tbody>
                    </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Hidden element to store stock data -->
    <div id="stockData" style="display: none;">{{ stocks|tojson|safe }}</div>
    
    <script>
        // Calculate and display statistics (kept for potential future use)
        function updateStats() {
            // Stats removed from header, keeping function for future use
        }
        
        // App version time is set by server, no need to update dynamically

        // Refresh data from server
        async function refreshData() {
            const button = document.querySelector('button[onclick="refreshData()"]');
            const originalText = button.innerHTML;
            
            button.innerHTML = 'ðŸ”„ Loading...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/refresh');
                const result = await response.json();
                
                if (result.message === 'Data refreshed successfully') {
                    // Reload the page to show updated data
                    window.location.reload();
                } else {
                    alert('Error refreshing data');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error refreshing data');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        // Market cap formatting function
        function formatMarketCap(marketCap) {
            if (marketCap >= 1000000000000) {
                return `$${(marketCap / 1000000000000).toFixed(1)}T`;
            } else if (marketCap >= 1000000000) {
                return `$${(marketCap / 1000000000).toFixed(1)}B`;
            } else {
                return `$${(marketCap / 1000000).toFixed(0)}MM`;
            }
        }
        
        // Filter functionality
        let allStocks = JSON.parse(document.getElementById('stockData').textContent);
        let filteredStocks = allStocks;
        
        
            // Handle custom threshold inputs for all filters
            function setupCustomThresholdHandlers() {
                // EPS Growth
                document.getElementById('epsGrowthThreshold').addEventListener('change', function() {
                    const customInput = document.getElementById('epsGrowthCustom');
                    customInput.style.display = this.value === 'custom' ? 'block' : 'none';
                });
                
                // RS vs SPY
                document.getElementById('rsSpyThreshold').addEventListener('change', function() {
                    const customInput = document.getElementById('rsSpyCustom');
                    customInput.style.display = this.value === 'custom' ? 'block' : 'none';
                });
                
                // RS vs Sector
                document.getElementById('rsSectorThreshold').addEventListener('change', function() {
                    const customInput = document.getElementById('rsSectorCustom');
                    customInput.style.display = this.value === 'custom' ? 'block' : 'none';
                });
            }
            
            setupCustomThresholdHandlers();
            
            // Fix EMA signals on page load
            updateTable();
        
            // Apply multiple filters
            document.getElementById('applyMultipleFilterButton').addEventListener('click', async function() {
                const filters = getActiveFilters();
                
                if (filters.length === 0) {
                    alert('Please select at least one filter');
                    return;
                }
                
                try {
                    // Apply filters locally with AND logic
                    filteredStocks = allStocks.filter(stock => {
                        return filters.every(filter => {
                            // Handle ticker filter
                            if (filter.metric === 'ticker') {
                                return stock.symbol.toUpperCase().includes(filter.value);
                            }
                            
                            const value = getStockValue(stock, filter.metric);
                            if (filter.metric.startsWith('d_') || filter.metric.startsWith('w_') || filter.metric.startsWith('m_')) {
                                // EMA filters - check if EMA > Price (boolean)
                                return value === true;
                            }
                            return value !== null && value > filter.threshold;
                        });
                    });
                    
                    updateTable();
                updateStats();
                    
                    // Show filter result message
                    const filterNames = filters.map(f => {
                        if (f.metric === 'ticker') {
                            return `${f.name}: ${f.value}`;
                        } else {
                            return `${f.name} > ${f.threshold}%`;
                        }
                    }).join(' AND ');
                    const message = `Filters applied: ${filteredStocks.length} stocks found with ${filterNames}`;
                    showFilterMessage(message, 'success');
                    
            } catch (error) {
                    console.error('Filter error:', error);
                    alert('Error applying filters');
                }
            });
        
        // Helper functions for multiple filters
        function getActiveFilters() {
            const filters = [];
            
            // Ticker filter
            if (document.getElementById('tickerCheck').checked) {
                const tickerValue = document.getElementById('tickerFilter').value.trim().toUpperCase();
                if (tickerValue) {
                    filters.push({
                        metric: 'ticker',
                        name: 'Ticker',
                        value: tickerValue
                    });
                }
            }
            
            // EPS Growth filter
            if (document.getElementById('epsGrowthCheck').checked) {
                const threshold = getThresholdValue('epsGrowthThreshold', 'epsGrowthCustom');
                if (threshold !== null) {
                    filters.push({
                        metric: 'eps_growth',
                        name: 'EPS Growth',
                        threshold: threshold
                    });
                }
            }
            
            // RS vs SPY filter
            if (document.getElementById('rsSpyCheck').checked) {
                const threshold = getThresholdValue('rsSpyThreshold', 'rsSpyCustom');
                if (threshold !== null) {
                    filters.push({
                        metric: 'rs_spy',
                        name: 'RS vs SPY',
                        threshold: threshold
                    });
                }
            }
            
            // RS vs Sector filter
            if (document.getElementById('rsSectorCheck').checked) {
                const threshold = getThresholdValue('rsSectorThreshold', 'rsSectorCustom');
                if (threshold !== null) {
                    filters.push({
                        metric: 'rs_sector',
                        name: 'RS vs Sector',
                        threshold: threshold
                    });
                }
            }
            
            // Individual EMA filters
            const emaFilters = [
                { id: 'd9emaCheck', ema: 'D_9EMA' },
                { id: 'd21emaCheck', ema: 'D_21EMA' },
                { id: 'd50emaCheck', ema: 'D_50EMA' },
                { id: 'w9emaCheck', ema: 'W_9EMA' },
                { id: 'w21emaCheck', ema: 'W_21EMA' },
                { id: 'w50emaCheck', ema: 'W_50EMA' },
                { id: 'm9emaCheck', ema: 'M_9EMA' },
                { id: 'm21emaCheck', ema: 'M_21EMA' }
            ];
            
            emaFilters.forEach(emaFilter => {
                if (document.getElementById(emaFilter.id).checked) {
                    filters.push({
                        metric: emaFilter.ema.toLowerCase(),
                        name: `${emaFilter.ema} > Price`,
                        threshold: true
                    });
                }
            });
            
            return filters;
        }
        
        function getThresholdValue(selectId, customId) {
            const select = document.getElementById(selectId);
            if (select.value === 'custom') {
                const customValue = parseFloat(document.getElementById(customId).value);
                return isNaN(customValue) ? null : customValue;
            } else {
                return parseFloat(select.value);
            }
        }
        
        function getStockValue(stock, metric) {
            switch (metric) {
                case 'eps_growth':
                    return stock.eps_growth?.quarter_over_quarter;
                case 'rs_spy':
                    return stock.relative_strength?.rs_spy;
                case 'rs_sector':
                    return stock.relative_strength?.rs_sector;
                case 'd_9ema':
                case 'd_21ema':
                case 'd_50ema':
                case 'w_9ema':
                case 'w_21ema':
                case 'w_50ema':
                case 'm_9ema':
                case 'm_21ema':
                    const emaKey = metric.toUpperCase();
                    return stock.ema_data?.[emaKey] !== null && stock.price > stock.ema_data[emaKey];
                default:
                    return null;
            }
        }
        
        function getEmaSignal(stock) {
            if (!stock.ema_data) return null;
            
            let aboveCount = 0;
            let belowCount = 0;
            let totalValidEmas = 0;
            
            for (const [emaKey, emaValue] of Object.entries(stock.ema_data)) {
                if (emaValue !== null) {
                    totalValidEmas++;
                    if (stock.price > emaValue) {
                        aboveCount++;
                    } else {
                        belowCount++;
                    }
                }
            }
            
            // If no valid EMAs, return null
            if (totalValidEmas === 0) return null;
            
            // Above ALL EMAs = Bullish
            if (aboveCount === totalValidEmas) return 'bullish';
            // Below ALL EMAs = Bearish
            if (belowCount === totalValidEmas) return 'bearish';
            // Otherwise = Mixed
            return 'mixed';
        }
        
        // Clear all filters
        document.getElementById('clearAllFiltersButton').addEventListener('click', function() {
            // Uncheck all filters
            document.getElementById('epsGrowthCheck').checked = false;
            document.getElementById('rsSpyCheck').checked = false;
            document.getElementById('rsSectorCheck').checked = false;
            
            // Uncheck all EMA filters
            const emaCheckboxes = ['d9emaCheck', 'd21emaCheck', 'd50emaCheck', 'w9emaCheck', 'w21emaCheck', 'w50emaCheck', 'm9emaCheck', 'm21emaCheck'];
            emaCheckboxes.forEach(id => {
                document.getElementById(id).checked = false;
            });
            
            // Reset all thresholds to defaults
            document.getElementById('epsGrowthThreshold').value = '25';
            document.getElementById('rsSpyThreshold').value = '10';
            document.getElementById('rsSectorThreshold').value = '5';
            
            // Hide custom inputs
            document.getElementById('epsGrowthCustom').style.display = 'none';
            document.getElementById('rsSpyCustom').style.display = 'none';
            document.getElementById('rsSectorCustom').style.display = 'none';
            
            // Show all stocks
            filteredStocks = allStocks;
            updateTable();
            updateStats();
            showFilterMessage('All filters cleared - showing all stocks', 'info');
        });
        
        function clearAllEMAFilters() {
            const emaCheckboxes = ['d9emaCheck', 'd21emaCheck', 'd50emaCheck', 'w9emaCheck', 'w21emaCheck', 'w50emaCheck', 'm9emaCheck', 'm21emaCheck'];
            emaCheckboxes.forEach(id => {
                document.getElementById(id).checked = false;
            });
        }
        
        // Update table with current stocks
        function updateTable() {
            const tbody = document.querySelector('tbody');
            tbody.innerHTML = '';
            
            filteredStocks.forEach(stock => {
                const row = tbody.insertRow();
                row.className = 'stock-row';
                
                // Symbol
                const symbolCell = row.insertCell();
                symbolCell.innerHTML = `<strong>${stock.symbol}</strong>`;
                
                // Company
                const companyCell = row.insertCell();
                companyCell.className = 'company-column';
                companyCell.textContent = stock.company_name;
                
                // Market Cap
                const marketCapCell = row.insertCell();
                marketCapCell.className = 'market-cap';
                marketCapCell.textContent = formatMarketCap(stock.market_cap);
                
                    // Price
                    row.insertCell().textContent = `$${stock.price.toFixed(2)}`;
                    
                    // EPS Growth %
                    const growthCell = row.insertCell();
                    if (stock.eps_growth && stock.eps_growth.quarter_over_quarter !== null) {
                        const growth = stock.eps_growth.quarter_over_quarter;
                        growthCell.className = growth > 0 ? 'positive-eps' : growth < 0 ? 'negative-eps' : '';
                        growthCell.textContent = `${growth.toFixed(1)}%`;
                    } else {
                        growthCell.innerHTML = '<span class="text-muted">N/A</span>';
                    }
                    
                    // RS vs SPY
                    const rsSpyCell = row.insertCell();
                    if (stock.relative_strength && stock.relative_strength.rs_spy !== null) {
                        const rsSpy = stock.relative_strength.rs_spy;
                        rsSpyCell.className = rsSpy > 0 ? 'positive-eps' : rsSpy < 0 ? 'negative-eps' : '';
                        rsSpyCell.textContent = `${rsSpy.toFixed(1)}%`;
                    } else {
                        rsSpyCell.innerHTML = '<span class="text-muted">N/A</span>';
                    }
                    
                    // RS vs Sector
                    const rsSectorCell = row.insertCell();
                    if (stock.relative_strength && stock.relative_strength.rs_sector !== null) {
                        const rsSector = stock.relative_strength.rs_sector;
                        rsSectorCell.className = rsSector > 0 ? 'positive-eps' : rsSector < 0 ? 'negative-eps' : '';
                        rsSectorCell.textContent = `${rsSector.toFixed(1)}%`;
                    } else {
                        rsSectorCell.innerHTML = '<span class="text-muted">N/A</span>';
                    }
                    
                    // EMA Signal
                    const emaCell = row.insertCell();
                    const emaButton = document.createElement('button');
                    emaButton.className = 'btn btn-sm btn-outline-info ema-signal-btn';
                    emaButton.style.cursor = 'pointer';
                    emaButton.onclick = () => showEmaDetails(stock.symbol);
                    emaButton.title = 'ðŸ“Š Click to view detailed EMA analysis';
                    
                    if (stock.ema_data) {
                        const emaSignal = getEmaSignal(stock);
                        if (emaSignal === 'bullish') {
                            emaButton.innerHTML = 'ðŸŸ¢ Bullish';
                        } else if (emaSignal === 'bearish') {
                            emaButton.innerHTML = 'ðŸ”´ Bearish';
                        } else {
                            emaButton.innerHTML = 'ðŸŸ¡ Mixed';
                        }
                    } else {
                        emaButton.innerHTML = '<span class="text-muted">N/A</span>';
                    }
                    emaCell.appendChild(emaButton);
                
                // EPS History
                const historyCell = row.insertCell();
                historyCell.className = 'eps-history-column';
                if (stock.eps_history && stock.eps_history.quarterly) {
                    const historyDiv = document.createElement('div');
                    historyDiv.className = 'eps-history';
                    Object.entries(stock.eps_history.quarterly).forEach(([quarterDate, eps]) => {
                        const small = document.createElement('small');
                        small.className = 'd-block';
                        
                        // Convert date to Q1 2024 format
                        const year = quarterDate.substring(0, 4);
                        const month = quarterDate.substring(5, 7);
                        let quarter;
                        
                        if (month === "01" || month === "02" || month === "03") {
                            quarter = "Q1";
                        } else if (month === "04" || month === "05" || month === "06") {
                            quarter = "Q2";
                        } else if (month === "07" || month === "08" || month === "09") {
                            quarter = "Q3";
                        } else {
                            quarter = "Q4";
                        }
                        
                        small.innerHTML = `${quarter} ${year}: <span class="eps-value">$${eps.toFixed(2)}</span>`;
                        historyDiv.appendChild(small);
                    });
                    historyCell.appendChild(historyDiv);
                } else {
                    historyCell.innerHTML = '<small class="text-muted">N/A</small>';
                }
                
                // Sector
                row.insertCell().textContent = stock.sector;
            });
        }
        
        // Show filter message
        function showFilterMessage(message, type) {
            // Remove existing message
            const existingMessage = document.querySelector('.filter-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // Create new message
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert alert-${type} filter-message mt-3`;
            messageDiv.textContent = message;
            
            // Insert after filter card
            const filterCard = document.querySelector('.card .card-header');
            if (filterCard && filterCard.textContent.includes('EPS Growth Filter')) {
                filterCard.closest('.card').parentNode.insertBefore(messageDiv, filterCard.closest('.card').nextSibling);
            }
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }
        
        // Show EMA details modal
        function showEmaDetails(symbol) {
            const stock = allStocks.find(s => s.symbol === symbol);
            if (!stock || !stock.ema_data) {
                alert('EMA data not available for ' + symbol);
                return;
            }

            let emaDetails = `
                <div class="mb-3">
                    <h5 class="mb-2">EMA Analysis for ${symbol}</h5>
                    <div class="alert alert-info mb-3">
                        <strong>Current Price:</strong> $${stock.price.toFixed(2)}
                    </div>
                </div>
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>EMA</th>
                            <th>Value</th>
                            <th>vs Current Price</th>
                            <th>Difference</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const emaKeys = ['D_9EMA', 'D_21EMA', 'D_50EMA', 'W_9EMA', 'W_21EMA', 'W_50EMA', 'M_9EMA', 'M_21EMA'];
            
            emaKeys.forEach(emaKey => {
                const emaValue = stock.ema_data[emaKey];
                if (emaValue !== null) {
                    const difference = ((stock.price - emaValue) / emaValue * 100).toFixed(1);
                    const vsPrice = stock.price > emaValue ? 'ðŸŸ¢ Above' : 'ðŸ”´ Below';
                    const diffClass = stock.price > emaValue ? 'text-success' : 'text-danger';
                    emaDetails += `
                        <tr>
                            <td><strong>${emaKey}</strong></td>
                            <td>$${emaValue.toFixed(2)}</td>
                            <td>${vsPrice}</td>
                            <td class="${diffClass}">${difference > 0 ? '+' : ''}${difference}%</td>
                        </tr>
                    `;
                } else {
                    emaDetails += `
                        <tr>
                            <td><strong>${emaKey}</strong></td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                        </tr>
                    `;
                }
            });
            
            emaDetails += '</tbody></table>';
            
            // Create and show modal
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">ðŸ“Š EMA Technical Analysis</h5>
                            <button type="button" class="btn-close btn-close-white" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        <div class="modal-body">
                            ${emaDetails}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="this.closest('.modal').remove()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Initialize stats on page load
        updateStats();
    </script>
</body>
</html>