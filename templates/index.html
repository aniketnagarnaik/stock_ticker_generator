<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Data Viewer - Template v3</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            /* Light mode colors */
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --header-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --table-header-bg: #495057;
            --table-hover: #f8f9fa;
            --btn-primary: #007bff;
            --btn-secondary: #6c757d;
            --positive-color: #28a745;
            --negative-color: #dc3545;
        }

        [data-theme="dark"] {
            /* Dark mode colors */
            --bg-primary: #1a1a1a;
            --bg-secondary: #3a3a3a;
            --bg-card: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #e9ecef;
            --text-muted: #adb5bd;
            --border-color: #495057;
            --header-bg: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            --table-header-bg: #1a202c;
            --table-hover: #374151;
            --btn-primary: #4299e1;
            --btn-secondary: #718096;
            --positive-color: #48bb78;
            --negative-color: #f56565;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container {
            margin-top: 10px;
            padding: 0 5px;
        }
        .card {
            margin-bottom: 8px;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            background-color: var(--bg-card);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .card-header {
            background-color: var(--btn-primary);
            color: white;
            font-weight: bold;
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            transition: background-color 0.3s ease;
        }
        .card-body {
            padding: 0.6rem;
            background-color: var(--bg-card);
            transition: background-color 0.3s ease;
        }
        
        /* Mobile-first responsive table */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            overflow-y: visible;
        }
        .table {
            margin-bottom: 0;
            font-size: 0.8rem;
            min-width: 800px; /* Ensure horizontal scroll on mobile */
        }
        .table th {
            background-color: var(--table-header-bg);
            color: white;
            padding: 0.4rem 0.3rem;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
            transition: background-color 0.3s ease;
        }
        .table td {
            padding: 0.3rem;
            vertical-align: middle;
            white-space: nowrap;
            background-color: var(--bg-card);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            border-bottom: 1px solid var(--border-color);
        }
        
        /* Column width constraints */
        .company-column {
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .eps-history-column {
            max-width: 250px;
            min-width: 200px;
            font-size: 0.85rem;
            line-height: 1.2;
        }
        .eps-history-column .quarterly-eps {
            display: block;
            margin: 1px 0;
            font-size: 0.8rem;
        }
        
        /* EPS Bar Chart Styles */
        .eps-bar {
            width: 18px;
            min-height: 5px;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .eps-bar:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        .eps-bar-1 { background: #667eea; }
        .eps-bar-2 { background: #764ba2; }
        .eps-bar-3 { background: #f093fb; }
        .eps-bar-4 { background: #4facfe; }
        
        /* Mobile-specific optimizations */
        @media (max-width: 768px) {
            .container {
                padding: 0 2px;
                margin-top: 5px;
            }
            .card-body {
                padding: 0.4rem;
            }
            .table {
                font-size: 0.75rem;
            }
            .table th {
                padding: 0.3rem 0.2rem;
                font-size: 0.7rem;
            }
            .table td {
                padding: 0.25rem 0.2rem;
            }
            .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
            .form-control, .form-select {
                font-size: 0.8rem;
                padding: 0.25rem 0.4rem;
            }
            
            /* Mobile header optimization */
            .compact-header {
                padding: 10px 0;
            }
            h4 {
                font-size: 1.1rem;
            }
            .timestamp {
                margin-top: 4px;
            }
            .timestamp small {
                font-size: 0.8rem;
                color: rgba(255, 255, 255, 0.9) !important;
                font-weight: 500;
            }
            .subtitle-text {
                font-size: 0.85rem;
                color: rgba(255, 255, 255, 0.9) !important;
                font-weight: 500;
            }
            .timestamp-text {
                font-size: 0.8rem;
                color: rgba(255, 255, 255, 0.9) !important;
                font-weight: 500;
            }
        }
        .stock-row {
            transition: background-color 0.2s;
        }
        .stock-row:hover td {
            background-color: var(--table-hover) !important;
        }
        
        /* Fix Bootstrap table-striped for dark mode */
        .table-striped > tbody > tr:nth-of-type(odd) > td {
            background-color: var(--bg-card) !important;
            color: var(--text-primary) !important;
        }
        
        .table-striped > tbody > tr:nth-of-type(even) > td {
            background-color: var(--bg-secondary) !important;
            color: var(--text-primary) !important;
        }
        .market-cap {
            font-weight: bold;
        }
        .positive-eps {
            color: var(--positive-color);
            font-weight: 600;
        }
        .negative-eps {
            color: var(--negative-color);
            font-weight: 600;
        }
        .eps-history {
            font-size: 0.9em;
            line-height: 1.3;
        }
        .eps-history small {
            color: var(--text-primary);
            font-weight: 500;
        }
        .eps-value {
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        /* Fix text-muted class for dark mode */
        .text-muted {
            color: var(--text-muted) !important;
        }
        .compact-header {
            background: var(--header-bg);
            color: white;
            padding: 1rem 0;
            margin-bottom: 1rem;
            transition: background 0.3s ease;
        }
        .stats-inline {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
        }
        .filter-compact {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            gap: 6px;
            align-items: center;
            padding: 4px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-secondary);
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }
        .filter-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        .filter-compact .form-control,
        .filter-compact .form-select {
            font-size: 0.75rem;
            padding: 0.2rem 0.4rem;
        }
        
        /* Mobile filter optimization */
        @media (max-width: 768px) {
            .filter-compact {
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
            }
            .filter-group {
                justify-content: space-between;
                padding: 6px;
                gap: 8px;
            }
            .filter-actions {
                justify-content: center;
                margin-top: 5px;
            }
            .filter-compact .form-control,
            .filter-compact .form-select {
                font-size: 0.7rem;
                padding: 0.15rem 0.3rem;
                min-width: 60px;
            }
        }
            .form-check-inline {
                margin-right: 0.5rem;
            }
            .form-check-input {
                margin-right: 0.25rem;
            }
        .btn-sm {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .badge {
            font-size: 0.7rem;
        }
        .timestamp {
            margin-top: 4px;
        }
        .timestamp small {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            transition: color 0.3s ease;
        }
        .subtitle-text {
            color: rgba(255, 255, 255, 0.9) !important;
            font-size: 0.9rem;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        .timestamp-text {
            color: rgba(255, 255, 255, 0.9) !important;
            font-size: 0.85rem;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        .badge-sm {
            font-size: 0.65rem;
            padding: 0.2rem 0.4rem;
        }
        
        /* EMA Signal Button Styling - Enhanced UX */
        .ema-signal-btn {
            cursor: pointer !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid var(--btn-primary) !important;
            font-weight: 600;
            position: relative;
            background: var(--btn-primary) !important;
            color: white !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 8px;
            padding: 6px 10px !important;
            font-size: 0.8rem !important;
            min-width: 110px;
            position: relative;
            overflow: hidden;
        }
        
        /* Dark mode specific EMA button styling */
        [data-theme="dark"] .ema-signal-btn {
            background: var(--btn-primary) !important;
            border-color: var(--btn-primary) !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            animation: none; /* Remove pulsing in dark mode */
        }
        
        .ema-signal-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            background: var(--btn-primary) !important;
            border-color: var(--btn-primary) !important;
        }
        
        /* Dark mode hover - more subtle */
        [data-theme="dark"] .ema-signal-btn:hover {
            transform: translateY(-1px) scale(1.01);
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            background: var(--btn-primary) !important;
            opacity: 0.9;
        }
        
        .ema-signal-btn:active {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 4px 12px rgba(40,167,69,0.5);
            transition: all 0.1s ease;
        }
        
        .ema-signal-btn:focus {
            outline: 3px solid rgba(40,167,69,0.5);
            outline-offset: 2px;
        }
        
        /* Animated background effect */
        .ema-signal-btn::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s ease;
        }
        
        .ema-signal-btn:hover::before {
            left: 100%;
        }
        
        /* Click here indicator - subtle */
        .ema-signal-btn::after {
            content: " 👆";
            font-size: 0.7rem;
            opacity: 0.7;
        }
        
        /* Mobile optimization */
        @media (max-width: 768px) {
            .ema-signal-btn {
                font-size: 0.7rem !important;
                padding: 6px 10px !important;
                min-width: 100px;
            }
            .ema-signal-btn::after {
                content: " 👆";
                font-size: 0.6rem;
            }
        }

        /* Dark Mode Toggle Button */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 1.2rem;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        /* Mobile theme toggle */
        @media (max-width: 768px) {
            .theme-toggle {
                top: 10px;
                right: 10px;
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
        }

        /* EMA Modal Dark Mode Styling */
        .ema-modal {
            background-color: var(--bg-card) !important;
            color: var(--text-primary) !important;
        }

        .ema-modal .modal-header {
            background-color: var(--btn-primary) !important;
            border-bottom: 1px solid var(--border-color) !important;
        }

        .ema-modal .modal-body {
            background-color: var(--bg-card) !important;
            color: var(--text-primary) !important;
        }

        .ema-modal .modal-footer {
            background-color: var(--bg-card) !important;
            border-top: 1px solid var(--border-color) !important;
        }

        .ema-modal .table {
            background-color: var(--bg-card) !important;
            color: var(--text-primary) !important;
        }

        .ema-modal .table th {
            background-color: var(--table-header-bg) !important;
            color: white !important;
            border-bottom: 1px solid var(--border-color) !important;
        }

        .ema-modal .table td {
            background-color: var(--bg-card) !important;
            color: var(--text-primary) !important;
            border-bottom: 1px solid var(--border-color) !important;
        }

        .ema-modal .alert-info {
            background-color: var(--bg-secondary) !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-primary) !important;
        }

        .ema-modal .text-success {
            color: var(--positive-color) !important;
        }

        .ema-modal .text-danger {
            color: var(--negative-color) !important;
        }

        .ema-modal .btn-primary {
            background-color: var(--btn-primary) !important;
            border-color: var(--btn-primary) !important;
        }

        /* Form Labels Dark Mode Fix */
        .form-check-label {
            color: var(--text-primary) !important;
        }

        .form-label {
            color: var(--text-primary) !important;
        }

        /* Accordion Dark Mode Fix */
        .accordion-button {
            background-color: var(--bg-card) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }

        .accordion-button:not(.collapsed) {
            background-color: var(--btn-primary) !important;
            color: white !important;
        }

        .accordion-body {
            background-color: var(--bg-card) !important;
            color: var(--text-primary) !important;
        }

        .accordion-item {
            background-color: var(--bg-card) !important;
            border-color: var(--border-color) !important;
        }
    </style>
</head>
<body>
    <!-- Dark Mode Toggle Button -->
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
        <span id="theme-icon">🌙</span>
    </button>

    <div class="compact-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-12 text-center">
                    <h4 class="mb-1">📈 Stock Data Viewer</h4>
                    <div class="timestamp mt-1">
                        <small class="timestamp-text">App version updated: <span id="appVersionTime">{{ server_start_time }}</span></small>
                        {% if cache_status.last_updated %}
                        <br><small class="timestamp-text">Data updated: <span id="cacheTime">{{ cache_status.last_updated }}</span> 
                        <span class="badge bg-{% if cache_status.cache_valid %}success{% else %}warning{% endif %} badge-sm">
                            {% if cache_status.cache_valid %}Fresh{% else %}Stale{% endif %}
                        </span></small>
                        {% endif %}
                </div>
                    <div class="mt-2">
                        <button class="btn btn-light btn-sm" onclick="refreshData()">
                            🔄 Refresh
                        </button>
                </div>
            </div>
        </div>
                </div>
                </div>

    <div class="container">

        <!-- Multiple Filter -->
        <div class="row mb-2">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0">📊 Multiple Filters</h6>
                </div>
                    <div class="card-body py-2">
                        <div class="filter-compact">
                            <!-- Ticker Filter -->
                            <div class="filter-group">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="tickerCheck">
                                    <label class="form-check-label" for="tickerCheck">Ticker:</label>
            </div>
                                <input type="text" class="form-control" id="tickerFilter" placeholder="e.g. AAPL, MSFT" style="width: 120px;">
        </div>

                            <!-- EPS Growth Filter -->
                            <div class="filter-group">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="epsGrowthCheck">
                                    <label class="form-check-label" for="epsGrowthCheck">EPS Growth ></label>
                </div>
                                <select class="form-select" id="epsGrowthThreshold" style="width: auto;">
                                    <option value="25">25%</option>
                                    <option value="35">35%</option>
                                    <option value="custom">Custom</option>
                    </select>
                                <input type="number" class="form-control" id="epsGrowthCustom" placeholder="%" min="-100" max="1000" step="0.1" style="width: 80px; display: none;">
                </div>

                            <!-- RS vs SPY Filter -->
                            <div class="filter-group">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="rsSpyCheck">
                                    <label class="form-check-label" for="rsSpyCheck">RS vs SPY ></label>
                </div>
                                <select class="form-select" id="rsSpyThreshold" style="width: auto;">
                                    <option value="10">10%</option>
                                    <option value="20">20%</option>
                                    <option value="custom">Custom</option>
                                </select>
                                <input type="number" class="form-control" id="rsSpyCustom" placeholder="%" min="-100" max="1000" step="0.1" style="width: 80px; display: none;">
                </div>

                            <!-- RS vs Sector Filter -->
                            <div class="filter-group">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="rsSectorCheck">
                                    <label class="form-check-label" for="rsSectorCheck">RS vs Sector ></label>
                </div>
                                <select class="form-select" id="rsSectorThreshold" style="width: auto;">
                                    <option value="5">5%</option>
                                    <option value="15">15%</option>
                                    <option value="custom">Custom</option>
                                </select>
                                <input type="number" class="form-control" id="rsSectorCustom" placeholder="%" min="-100" max="1000" step="0.1" style="width: 80px; display: none;">
            </div>

                            <!-- EMA Filters - Collapsible Groups -->
                            <div class="filter-group">
                                <div class="accordion" id="emaFiltersAccordion">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="emaFiltersHeader">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#emaFiltersCollapse" aria-expanded="false" aria-controls="emaFiltersCollapse">
                                                📊 EMA Filters
                    </button>
                                        </h2>
                                        <div id="emaFiltersCollapse" class="accordion-collapse collapse" aria-labelledby="emaFiltersHeader" data-bs-parent="#emaFiltersAccordion">
                                            <div class="accordion-body">
                                                <!-- Daily EMAs -->
                                                <div class="mb-2">
                                                    <label class="form-label fw-bold">📅 Daily EMAs:</label>
            <div class="row">
                                                        <div class="col-md-4">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="d9emaCheck">
                                                                <label class="form-check-label" for="d9emaCheck">D_9EMA > Price</label>
                </div>
                </div>
                                                        <div class="col-md-4">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="d21emaCheck">
                                                                <label class="form-check-label" for="d21emaCheck">D_21EMA > Price</label>
                </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="d50emaCheck">
                                                                <label class="form-check-label" for="d50emaCheck">D_50EMA > Price</label>
                    </div>
                </div>
            </div>
        </div>

                                                <!-- Weekly EMAs -->
                                                <div class="mb-2">
                                                    <label class="form-label fw-bold">📆 Weekly EMAs:</label>
                                                    <div class="row">
                                                        <div class="col-md-4">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="w9emaCheck">
                                                                <label class="form-check-label" for="w9emaCheck">W_9EMA > Price</label>
                </div>
            </div>
                                                        <div class="col-md-4">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="w21emaCheck">
                                                                <label class="form-check-label" for="w21emaCheck">W_21EMA > Price</label>
                </div>
            </div>
                                                        <div class="col-md-4">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="w50emaCheck">
                                                                <label class="form-check-label" for="w50emaCheck">W_50EMA > Price</label>
                </div>
                </div>
            </div>
        </div>

                                                <!-- Monthly EMAs -->
                                                <div class="mb-2">
                                                    <label class="form-label fw-bold">📅 Monthly EMAs:</label>
        <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="m9emaCheck">
                                                                <label class="form-check-label" for="m9emaCheck">M_9EMA > Price</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="m21emaCheck">
                                                                <label class="form-check-label" for="m21emaCheck">M_21EMA > Price</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                </div>
            </div>
                    </div>
                </div>
                
                            <!-- Action Buttons -->
                            <div class="filter-actions">
                                <button class="btn btn-success btn-sm" id="applyMultipleFilterButton">Apply Filters</button>
                                <button class="btn btn-secondary btn-sm" id="clearAllFiltersButton">Clear All</button>
                </div>
            </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stock Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Stock Data</h5>
                    </div>
                    <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                            <th>Symbol</th>
                                <th style="max-width: 120px;">Company</th>
                                            <th>Market Cap</th>
                                <th>Price</th>
                                        <th>EPS Growth %</th>
                                        <th>RS vs SPY</th>
                                        <th>RS vs Sector</th>
                                        <th>EMA Signal</th>
                                        <th style="min-width: 200px; max-width: 250px;">EPS History</th>
                                <th>Sector</th>
                            </tr>
                        </thead>
                                <tbody>
                                    {% for stock in stocks %}
                                    <tr class="stock-row">
                                        <td><strong>{{ stock.symbol }}</strong></td>
                                        <td class="company-column">{{ stock.company_name }}</td>
                                        <td class="market-cap">{{ stock.market_cap|format_market_cap }}</td>
                                        <td>${{ "%.2f"|format(stock.price) }}</td>
                                        <td class="{% if stock.eps_growth and stock.eps_growth.quarter_over_quarter and stock.eps_growth.quarter_over_quarter > 0 %}positive-eps{% elif stock.eps_growth and stock.eps_growth.quarter_over_quarter and stock.eps_growth.quarter_over_quarter < 0 %}negative-eps{% endif %}">
                                            {% if stock.eps_growth and stock.eps_growth.quarter_over_quarter is not none %}
                                                {{ "%.1f"|format(stock.eps_growth.quarter_over_quarter) }}%
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td class="{% if stock.relative_strength and stock.relative_strength.rs_spy and stock.relative_strength.rs_spy > 0 %}positive-eps{% elif stock.relative_strength and stock.relative_strength.rs_spy and stock.relative_strength.rs_spy < 0 %}negative-eps{% endif %}">
                                            {% if stock.relative_strength and stock.relative_strength.rs_spy is not none %}
                                                {{ "%.1f"|format(stock.relative_strength.rs_spy) }}%
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td class="{% if stock.relative_strength and stock.relative_strength.rs_sector and stock.relative_strength.rs_sector > 0 %}positive-eps{% elif stock.relative_strength and stock.relative_strength.rs_sector and stock.relative_strength.rs_sector < 0 %}negative-eps{% endif %}">
                                            {% if stock.relative_strength and stock.relative_strength.rs_sector is not none %}
                                                {{ "%.1f"|format(stock.relative_strength.rs_sector) }}%
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-info ema-signal-btn" onclick="showEmaDetails('{{ stock.symbol }}')" title="📊 Click to view detailed EMA analysis" style="cursor: pointer;">
                                                {% if stock.ema_data %}
                                                    {% set above_count = 0 %}
                                                    {% set below_count = 0 %}
                                                    {% set total_valid_emas = 0 %}
                                                    {% for ema_key, ema_value in stock.ema_data.items() %}
                                                        {% if ema_value is not none %}
                                                            {% set total_valid_emas = total_valid_emas + 1 %}
                                                            {% if stock.price > ema_value %}
                                                                {% set above_count = above_count + 1 %}
                                                            {% else %}
                                                                {% set below_count = below_count + 1 %}
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                    {% if total_valid_emas > 0 %}
                                                        {% if above_count == total_valid_emas %}
                                                            🟢 Bullish Signal
                                                        {% elif below_count == total_valid_emas %}
                                                            🔴 Bearish Signal
                                                        {% else %}
                                                            🟡 Mixed Signal
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="text-muted">N/A</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">N/A</span>
                                                {% endif %}
                                            </button>
                                        </td>
                                        <td class="eps-history-column">
                                            {% if stock.eps_growth and stock.eps_growth.latest_quarters %}
                                                {% set quarters = stock.eps_growth.latest_quarters[:4] %}
                                                {% set min_eps = quarters|min %}
                                                {% set max_eps = quarters|max %}
                                                {% set range = max_eps - min_eps if (max_eps - min_eps) > 0 else 1 %}
                                                <div style="cursor: pointer; padding: 8px; text-align: center;" onclick="showEpsChart('{{ stock.symbol }}')">
                                                    <svg width="120" height="60" style="display: block; margin: 0 auto;">
                                                        <!-- Grid lines -->
                                                        <line x1="10" y1="40" x2="110" y2="40" stroke="var(--border-color)" stroke-width="1" stroke-dasharray="2,2"/>
                                                        <line x1="10" y1="25" x2="110" y2="25" stroke="var(--border-color)" stroke-width="1" stroke-dasharray="2,2"/>
                                                        <line x1="10" y1="10" x2="110" y2="10" stroke="var(--border-color)" stroke-width="1" stroke-dasharray="2,2"/>
                                                        
                                                        <!-- Line chart -->
                                                        <polyline points="{% for eps in quarters %}{% set x = 10 + (loop.index0 * 33.33) %}{% set y = 40 - ((eps - min_eps) / range * 30) %}{{ x }},{{ y }} {% endfor %}" fill="none" stroke="{% if quarters[-1] >= quarters[0] %}#10b981{% else %}#ef4444{% endif %}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                                                        
                                                        <!-- Data points -->
                                                        {% for eps in quarters %}
                                                            {% set x = 10 + (loop.index0 * 33.33) %}
                                                            {% set y = 40 - ((eps - min_eps) / range * 30) %}
                                                            <circle cx="{{ x }}" cy="{{ y }}" r="3" fill="{% if quarters[-1] >= quarters[0] %}#10b981{% else %}#ef4444{% endif %}" stroke="white" stroke-width="1.5">
                                                                <title>Q{{ loop.index }}: ${{ '%.2f'|format(eps) }}</title>
                                                            </circle>
                                                        {% endfor %}
                                                        
                                                        <!-- Value labels - Updated positioning - v2 -->
                                                        <text x="10" y="55" font-size="8" fill="var(--text-muted)" text-anchor="middle">${{ '%.2f'|format(quarters[0]) }}</text>
                                                        <text x="105" y="55" font-size="8" fill="var(--text-muted)" text-anchor="middle" font-weight="bold">${{ '%.2f'|format(quarters[-1]) }}</text>
                                                    </svg>
                                                    <small class="text-muted" style="font-size: 0.7rem;">📊 Click for details</small>
                                                </div>
                                            {% else %}
                                                <small class="text-muted">N/A</small>
                                            {% endif %}
                                        </td>
                                        <td><span class="badge bg-secondary">{{ stock.sector }}</span></td>
                                    </tr>
                                    {% endfor %}
                        </tbody>
                    </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- EPS History Chart Modal -->
    <div class="modal fade" id="epsChartModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                    <h5 class="modal-title" id="epsChartTitle">📊 EPS History</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="padding: 2rem;">
                    <canvas id="epsChart" style="max-height: 400px;"></canvas>
                    <div id="epsChartStats" class="mt-4" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <!-- Stats will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Hidden element to store stock data -->
    <div id="stockData" style="display: none;">{{ stocks|tojson|safe }}</div>
    
    <script>
        // Dark Mode Toggle Function
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            const currentTheme = body.getAttribute('data-theme');
            
            if (currentTheme === 'dark') {
                // Switch to light mode
                body.removeAttribute('data-theme');
                themeIcon.textContent = '🌙';
                localStorage.setItem('theme', 'light');
            } else {
                // Switch to dark mode
                body.setAttribute('data-theme', 'dark');
                themeIcon.textContent = '☀️';
                localStorage.setItem('theme', 'dark');
            }
        }

        // Initialize theme on page load
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            
            if (savedTheme === 'dark') {
                body.setAttribute('data-theme', 'dark');
                themeIcon.textContent = '☀️';
            } else {
                body.removeAttribute('data-theme');
                themeIcon.textContent = '🌙';
            }
        }

        // Calculate and display statistics (kept for potential future use)
        function updateStats() {
            // Stats removed from header, keeping function for future use
        }
        
        // App version time is set by server, no need to update dynamically

        // Refresh data from server
        async function refreshData() {
            const button = document.querySelector('button[onclick="refreshData()"]');
            const originalText = button.innerHTML;
            
            button.innerHTML = '🔄 Loading...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/refresh');
                const result = await response.json();
                
                if (result.success) {
                    // Reload the page to show updated data
                    window.location.reload();
                } else {
                    alert('Error refreshing data: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error refreshing data');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        // Market cap formatting function
        function formatMarketCap(marketCap) {
            if (marketCap >= 1000000000000) {
                return `$${(marketCap / 1000000000000).toFixed(1)}T`;
            } else if (marketCap >= 1000000000) {
                return `$${(marketCap / 1000000000).toFixed(1)}B`;
            } else {
                return `$${(marketCap / 1000000).toFixed(0)}MM`;
            }
        }
        
        // Filter functionality
        let allStocks = JSON.parse(document.getElementById('stockData').textContent);
        let filteredStocks = allStocks;
        
        
            // Handle custom threshold inputs for all filters
            function setupCustomThresholdHandlers() {
                // EPS Growth
                document.getElementById('epsGrowthThreshold').addEventListener('change', function() {
                    const customInput = document.getElementById('epsGrowthCustom');
                    customInput.style.display = this.value === 'custom' ? 'block' : 'none';
                });
                
                // RS vs SPY
                document.getElementById('rsSpyThreshold').addEventListener('change', function() {
                    const customInput = document.getElementById('rsSpyCustom');
                    customInput.style.display = this.value === 'custom' ? 'block' : 'none';
                });
                
                // RS vs Sector
                document.getElementById('rsSectorThreshold').addEventListener('change', function() {
                    const customInput = document.getElementById('rsSectorCustom');
                    customInput.style.display = this.value === 'custom' ? 'block' : 'none';
                });
            }
            
            setupCustomThresholdHandlers();
            
            // Fix EMA signals on page load
            updateTable();
        
            // Apply multiple filters
            document.getElementById('applyMultipleFilterButton').addEventListener('click', async function() {
                const filters = getActiveFilters();
                
                if (filters.length === 0) {
                    alert('Please select at least one filter');
                    return;
                }
                
                try {
                    // Apply filters locally with AND logic
                    filteredStocks = allStocks.filter(stock => {
                        return filters.every(filter => {
                            // Handle ticker filter
                            if (filter.metric === 'ticker') {
                                return stock.symbol.toUpperCase().includes(filter.value);
                            }
                            
                            const value = getStockValue(stock, filter.metric);
                            if (filter.metric.startsWith('d_') || filter.metric.startsWith('w_') || filter.metric.startsWith('m_')) {
                                // EMA filters - check if EMA > Price (boolean)
                                return value === true;
                            }
                            return value !== null && value > filter.threshold;
                        });
                    });
                    
                    updateTable();
                updateStats();
                    
                    // Show filter result message
                    const filterNames = filters.map(f => {
                        if (f.metric === 'ticker') {
                            return `${f.name}: ${f.value}`;
                        } else {
                            return `${f.name} > ${f.threshold}%`;
                        }
                    }).join(' AND ');
                    const message = `Filters applied: ${filteredStocks.length} stocks found with ${filterNames}`;
                    showFilterMessage(message, 'success');
                    
            } catch (error) {
                    console.error('Filter error:', error);
                    alert('Error applying filters');
                }
            });
        
        // Helper functions for multiple filters
        function getActiveFilters() {
            const filters = [];
            
            // Ticker filter
            if (document.getElementById('tickerCheck').checked) {
                const tickerValue = document.getElementById('tickerFilter').value.trim().toUpperCase();
                if (tickerValue) {
                    filters.push({
                        metric: 'ticker',
                        name: 'Ticker',
                        value: tickerValue
                    });
                }
            }
            
            // EPS Growth filter
            if (document.getElementById('epsGrowthCheck').checked) {
                const threshold = getThresholdValue('epsGrowthThreshold', 'epsGrowthCustom');
                if (threshold !== null) {
                    filters.push({
                        metric: 'eps_growth',
                        name: 'EPS Growth',
                        threshold: threshold
                    });
                }
            }
            
            // RS vs SPY filter
            if (document.getElementById('rsSpyCheck').checked) {
                const threshold = getThresholdValue('rsSpyThreshold', 'rsSpyCustom');
                if (threshold !== null) {
                    filters.push({
                        metric: 'rs_spy',
                        name: 'RS vs SPY',
                        threshold: threshold
                    });
                }
            }
            
            // RS vs Sector filter
            if (document.getElementById('rsSectorCheck').checked) {
                const threshold = getThresholdValue('rsSectorThreshold', 'rsSectorCustom');
                if (threshold !== null) {
                    filters.push({
                        metric: 'rs_sector',
                        name: 'RS vs Sector',
                        threshold: threshold
                    });
                }
            }
            
            // Individual EMA filters
            const emaFilters = [
                { id: 'd9emaCheck', ema: 'D_9EMA' },
                { id: 'd21emaCheck', ema: 'D_21EMA' },
                { id: 'd50emaCheck', ema: 'D_50EMA' },
                { id: 'w9emaCheck', ema: 'W_9EMA' },
                { id: 'w21emaCheck', ema: 'W_21EMA' },
                { id: 'w50emaCheck', ema: 'W_50EMA' },
                { id: 'm9emaCheck', ema: 'M_9EMA' },
                { id: 'm21emaCheck', ema: 'M_21EMA' }
            ];
            
            emaFilters.forEach(emaFilter => {
                if (document.getElementById(emaFilter.id).checked) {
                    filters.push({
                        metric: emaFilter.ema.toLowerCase(),
                        name: `${emaFilter.ema} > Price`,
                        threshold: true
                    });
                }
            });
            
            return filters;
        }
        
        function getThresholdValue(selectId, customId) {
            const select = document.getElementById(selectId);
            if (select.value === 'custom') {
                const customValue = parseFloat(document.getElementById(customId).value);
                return isNaN(customValue) ? null : customValue;
            } else {
                return parseFloat(select.value);
            }
        }
        
        function getStockValue(stock, metric) {
            switch (metric) {
                case 'eps_growth':
                    return stock.eps_growth?.quarter_over_quarter;
                case 'rs_spy':
                    return stock.relative_strength?.rs_spy;
                case 'rs_sector':
                    return stock.relative_strength?.rs_sector;
                case 'd_9ema':
                case 'd_21ema':
                case 'd_50ema':
                case 'w_9ema':
                case 'w_21ema':
                case 'w_50ema':
                case 'm_9ema':
                case 'm_21ema':
                    const emaKey = metric.toUpperCase();
                    return stock.ema_data?.[emaKey] !== null && stock.price > stock.ema_data[emaKey];
                default:
                    return null;
            }
        }
        
        function getEmaSignal(stock) {
            if (!stock.ema_data) return null;
            
            let aboveCount = 0;
            let belowCount = 0;
            let totalValidEmas = 0;
            
            for (const [emaKey, emaValue] of Object.entries(stock.ema_data)) {
                if (emaValue !== null) {
                    totalValidEmas++;
                    if (stock.price > emaValue) {
                        aboveCount++;
                    } else {
                        belowCount++;
                    }
                }
            }
            
            // If no valid EMAs, return null
            if (totalValidEmas === 0) return null;
            
            // Above ALL EMAs = Bullish
            if (aboveCount === totalValidEmas) return 'bullish';
            // Below ALL EMAs = Bearish
            if (belowCount === totalValidEmas) return 'bearish';
            // Otherwise = Mixed
            return 'mixed';
        }
        
        // Clear all filters
        document.getElementById('clearAllFiltersButton').addEventListener('click', function() {
            // Uncheck all filters
            document.getElementById('epsGrowthCheck').checked = false;
            document.getElementById('rsSpyCheck').checked = false;
            document.getElementById('rsSectorCheck').checked = false;
            
            // Uncheck all EMA filters
            const emaCheckboxes = ['d9emaCheck', 'd21emaCheck', 'd50emaCheck', 'w9emaCheck', 'w21emaCheck', 'w50emaCheck', 'm9emaCheck', 'm21emaCheck'];
            emaCheckboxes.forEach(id => {
                document.getElementById(id).checked = false;
            });
            
            // Reset all thresholds to defaults
            document.getElementById('epsGrowthThreshold').value = '25';
            document.getElementById('rsSpyThreshold').value = '10';
            document.getElementById('rsSectorThreshold').value = '5';
            
            // Hide custom inputs
            document.getElementById('epsGrowthCustom').style.display = 'none';
            document.getElementById('rsSpyCustom').style.display = 'none';
            document.getElementById('rsSectorCustom').style.display = 'none';
            
            // Show all stocks
            filteredStocks = allStocks;
            updateTable();
            updateStats();
            showFilterMessage('All filters cleared - showing all stocks', 'info');
        });
        
        function clearAllEMAFilters() {
            const emaCheckboxes = ['d9emaCheck', 'd21emaCheck', 'd50emaCheck', 'w9emaCheck', 'w21emaCheck', 'w50emaCheck', 'm9emaCheck', 'm21emaCheck'];
            emaCheckboxes.forEach(id => {
                document.getElementById(id).checked = false;
            });
        }
        
        // Update table with current stocks
        function updateTable() {
            const tbody = document.querySelector('tbody');
            tbody.innerHTML = '';
            
            filteredStocks.forEach(stock => {
                const row = tbody.insertRow();
                row.className = 'stock-row';
                
                // Symbol
                const symbolCell = row.insertCell();
                symbolCell.innerHTML = `<strong>${stock.symbol}</strong>`;
                
                // Company
                const companyCell = row.insertCell();
                companyCell.className = 'company-column';
                companyCell.textContent = stock.company_name;
                
                // Market Cap
                const marketCapCell = row.insertCell();
                marketCapCell.className = 'market-cap';
                marketCapCell.textContent = formatMarketCap(stock.market_cap);
                
                    // Price
                    row.insertCell().textContent = `$${stock.price.toFixed(2)}`;
                    
                    // EPS Growth %
                    const growthCell = row.insertCell();
                    if (stock.eps_growth && stock.eps_growth.quarter_over_quarter !== null) {
                        const growth = stock.eps_growth.quarter_over_quarter;
                        growthCell.className = growth > 0 ? 'positive-eps' : growth < 0 ? 'negative-eps' : '';
                        growthCell.textContent = `${growth.toFixed(1)}%`;
                    } else {
                        growthCell.innerHTML = '<span class="text-muted">N/A</span>';
                    }
                    
                    // RS vs SPY
                    const rsSpyCell = row.insertCell();
                    if (stock.relative_strength && stock.relative_strength.rs_spy !== null) {
                        const rsSpy = stock.relative_strength.rs_spy;
                        rsSpyCell.className = rsSpy > 0 ? 'positive-eps' : rsSpy < 0 ? 'negative-eps' : '';
                        rsSpyCell.textContent = `${rsSpy.toFixed(1)}%`;
                    } else {
                        rsSpyCell.innerHTML = '<span class="text-muted">N/A</span>';
                    }
                    
                    // RS vs Sector
                    const rsSectorCell = row.insertCell();
                    if (stock.relative_strength && stock.relative_strength.rs_sector !== null) {
                        const rsSector = stock.relative_strength.rs_sector;
                        rsSectorCell.className = rsSector > 0 ? 'positive-eps' : rsSector < 0 ? 'negative-eps' : '';
                        rsSectorCell.textContent = `${rsSector.toFixed(1)}%`;
                    } else {
                        rsSectorCell.innerHTML = '<span class="text-muted">N/A</span>';
                    }
                    
                    // EMA Signal
                    const emaCell = row.insertCell();
                    const emaButton = document.createElement('button');
                    emaButton.className = 'btn btn-sm btn-outline-info ema-signal-btn';
                    emaButton.style.cursor = 'pointer';
                    emaButton.onclick = () => showEmaDetails(stock.symbol);
                    emaButton.title = '📊 Click to view detailed EMA analysis';
                    
                    if (stock.ema_data) {
                        const emaSignal = getEmaSignal(stock);
                        if (emaSignal === 'bullish') {
                            emaButton.innerHTML = '🟢 Bullish Signal';
                        } else if (emaSignal === 'bearish') {
                            emaButton.innerHTML = '🔴 Bearish Signal';
                        } else {
                            emaButton.innerHTML = '🟡 Mixed Signal';
                        }
                    } else {
                        emaButton.innerHTML = '<span class="text-muted">N/A</span>';
                    }
                    emaCell.appendChild(emaButton);
                
                // EPS History - Line Chart
                const historyCell = row.insertCell();
                historyCell.className = 'eps-history-column';
                if (stock.eps_growth && stock.eps_growth.latest_quarters && stock.eps_growth.latest_quarters.length > 0) {
                    const quarters = stock.eps_growth.latest_quarters.slice(0, 4);
                    const minEps = Math.min(...quarters);
                    const maxEps = Math.max(...quarters);
                    const range = (maxEps - minEps) || 1;
                    
                    const container = document.createElement('div');
                    container.style.cssText = 'cursor: pointer; padding: 8px; text-align: center;';
                    container.onclick = () => showEpsChart(stock.symbol);
                    
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', '120');
            svg.setAttribute('height', '60');
            svg.style.cssText = 'display: block; margin: 0 auto;';
                    
                    // Grid lines
                    [40, 25, 10].forEach(y => {
                        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        line.setAttribute('x1', '10');
                        line.setAttribute('y1', y);
                        line.setAttribute('x2', '110');
                        line.setAttribute('y2', y);
                        line.setAttribute('stroke', 'var(--border-color)');
                        line.setAttribute('stroke-width', '1');
                        line.setAttribute('stroke-dasharray', '2,2');
                        svg.appendChild(line);
                    });
                    
                    // Calculate points for line
                    const points = quarters.map((eps, i) => {
                        const x = 10 + (i * 33.33);
                        const y = 40 - ((eps - minEps) / range * 30);
                        return `${x},${y}`;
                    }).join(' ');
                    
                    // Determine color based on trend
                    const trend = quarters[quarters.length - 1] >= quarters[0];
                    const color = trend ? '#10b981' : '#ef4444';
                    
                    // Draw line
                    const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
                    polyline.setAttribute('points', points);
                    polyline.setAttribute('fill', 'none');
                    polyline.setAttribute('stroke', color);
                    polyline.setAttribute('stroke-width', '2.5');
                    polyline.setAttribute('stroke-linecap', 'round');
                    polyline.setAttribute('stroke-linejoin', 'round');
                    svg.appendChild(polyline);
                    
                    // Draw points
                    quarters.forEach((eps, i) => {
                        const x = 10 + (i * 33.33);
                        const y = 40 - ((eps - minEps) / range * 30);
                        
                        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        circle.setAttribute('cx', x);
                        circle.setAttribute('cy', y);
                        circle.setAttribute('r', '3');
                        circle.setAttribute('fill', color);
                        circle.setAttribute('stroke', 'white');
                        circle.setAttribute('stroke-width', '1.5');
                        
                        const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
                        title.textContent = `Q${i + 1}: $${eps.toFixed(2)}`;
                        circle.appendChild(title);
                        
                        svg.appendChild(circle);
                    });
                    
            // Add value labels
            const textFirst = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            textFirst.setAttribute('x', '10');
            textFirst.setAttribute('y', '55');
            textFirst.setAttribute('font-size', '8');
            textFirst.setAttribute('fill', 'var(--text-muted)');
            textFirst.setAttribute('text-anchor', 'middle');
            textFirst.textContent = `$${quarters[0].toFixed(2)}`;
            svg.appendChild(textFirst);
            
            const textLast = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            textLast.setAttribute('x', '105');
            textLast.setAttribute('y', '55');
            textLast.setAttribute('font-size', '8');
            textLast.setAttribute('fill', 'var(--text-muted)');
            textLast.setAttribute('text-anchor', 'middle');
            textLast.setAttribute('font-weight', 'bold');
            textLast.textContent = `$${quarters[quarters.length - 1].toFixed(2)}`;
            svg.appendChild(textLast);
                    
                    container.appendChild(svg);
                    
                    const clickText = document.createElement('small');
                    clickText.className = 'text-muted';
                    clickText.style.fontSize = '0.7rem';
                    clickText.textContent = '📊 Click for details';
                    container.appendChild(clickText);
                    
                    historyCell.appendChild(container);
                } else {
                    historyCell.innerHTML = '<small class="text-muted">N/A</small>';
                }
                
                // Sector
                row.insertCell().textContent = stock.sector;
            });
        }
        
        // Show filter message
        function showFilterMessage(message, type) {
            // Remove existing message
            const existingMessage = document.querySelector('.filter-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // Create new message
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert alert-${type} filter-message mt-3`;
            messageDiv.textContent = message;
            
            // Insert after filter card
            const filterCard = document.querySelector('.card .card-header');
            if (filterCard && filterCard.textContent.includes('EPS Growth Filter')) {
                filterCard.closest('.card').parentNode.insertBefore(messageDiv, filterCard.closest('.card').nextSibling);
            }
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }
        
        // Show EMA details modal
        function showEmaDetails(symbol) {
            const stock = allStocks.find(s => s.symbol === symbol);
            if (!stock || !stock.ema_data) {
                alert('EMA data not available for ' + symbol);
                return;
            }

            let emaDetails = `
                <div class="mb-3">
                    <h5 class="mb-2">EMA Analysis for ${symbol}</h5>
                    <div class="alert alert-info mb-3 ema-modal">
                        <strong>Current Price:</strong> $${stock.price.toFixed(2)}
                    </div>
                </div>
                <table class="table table-striped table-hover ema-modal">
                    <thead class="ema-modal">
                        <tr>
                            <th>EMA</th>
                            <th>Value</th>
                            <th>vs Current Price</th>
                            <th>Difference</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const emaKeys = ['D_9EMA', 'D_21EMA', 'D_50EMA', 'W_9EMA', 'W_21EMA', 'W_50EMA', 'M_9EMA', 'M_21EMA'];
            
            emaKeys.forEach(emaKey => {
                const emaValue = stock.ema_data[emaKey];
                if (emaValue !== null) {
                    const difference = ((stock.price - emaValue) / emaValue * 100).toFixed(1);
                    const vsPrice = stock.price > emaValue ? '🟢 Above' : '🔴 Below';
                    const diffClass = stock.price > emaValue ? 'text-success' : 'text-danger';
                    emaDetails += `
                        <tr class="ema-modal">
                            <td class="ema-modal"><strong>${emaKey}</strong></td>
                            <td class="ema-modal">$${emaValue.toFixed(2)}</td>
                            <td class="ema-modal">${vsPrice}</td>
                            <td class="ema-modal ${diffClass}">${difference > 0 ? '+' : ''}${difference}%</td>
                        </tr>
                    `;
                } else {
                    emaDetails += `
                        <tr class="ema-modal">
                            <td class="ema-modal"><strong>${emaKey}</strong></td>
                            <td class="ema-modal">-</td>
                            <td class="ema-modal">-</td>
                            <td class="ema-modal">-</td>
                        </tr>
                    `;
                }
            });
            
            emaDetails += '</tbody></table>';
            
            // Create and show modal
            const modal = document.createElement('div');
            modal.className = 'modal fade show ema-modal';
            modal.style.display = 'block';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content ema-modal">
                        <div class="modal-header ema-modal">
                            <h5 class="modal-title">📊 EMA Technical Analysis</h5>
                            <button type="button" class="btn-close btn-close-white" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        <div class="modal-body ema-modal">
                            ${emaDetails}
                        </div>
                        <div class="modal-footer ema-modal">
                            <button type="button" class="btn btn-primary ema-modal" onclick="this.closest('.modal').remove()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // EPS Chart Functions
        let epsChartInstance = null;

        function showEpsChart(symbol) {
            const stockData = JSON.parse(document.getElementById('stockData').textContent);
            const stock = stockData.find(s => s.symbol === symbol);
            
            if (!stock || !stock.eps_history || !stock.eps_history.quarterly) {
                alert('No EPS history available for this stock');
                return;
            }

            // Prepare data
            const quarterly = stock.eps_history.quarterly;
            const sortedQuarters = Object.entries(quarterly).sort((a, b) => a[0].localeCompare(b[0]));
            
            const labels = sortedQuarters.map(([date, _]) => {
                const d = new Date(date);
                const year = d.getFullYear();
                const month = d.getMonth() + 1;
                const quarter = Math.ceil(month / 3);
                return `Q${quarter} ${year}`;
            });
            
            const values = sortedQuarters.map(([_, eps]) => eps);
            
            // Calculate stats
            const avgEPS = (values.reduce((a, b) => a + b, 0) / values.length).toFixed(2);
            const maxEPS = Math.max(...values).toFixed(2);
            const minEPS = Math.min(...values).toFixed(2);
            const latestEPS = values[values.length - 1].toFixed(2);
            const growth = values.length >= 2 ? 
                (((values[values.length - 1] - values[values.length - 2]) / values[values.length - 2]) * 100).toFixed(1) : 0;
            
            // Update modal
            document.getElementById('epsChartTitle').textContent = `📊 EPS History - ${stock.symbol} (${stock.company_name})`;
            
            // Render chart
            const ctx = document.getElementById('epsChart').getContext('2d');
            
            if (epsChartInstance) {
                epsChartInstance.destroy();
            }
            
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#e0e0e0' : '#333';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            
            epsChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'EPS ($)',
                        data: values,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: isDark ? '#2d3748' : '#fff',
                            titleColor: textColor,
                            bodyColor: textColor,
                            borderColor: gridColor,
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return `EPS: $${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                color: textColor,
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            },
                            grid: {
                                color: gridColor
                            }
                        },
                        x: {
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                color: gridColor
                            }
                        }
                    }
                }
            });
            
            // Update stats
            const statsHTML = `
                <div style="text-align: center; padding: 1rem; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border-color);">
                    <div style="font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem;">Latest EPS</div>
                    <div style="font-size: 1.8rem; font-weight: 700; color: var(--text-primary);">$${latestEPS}</div>
                    <div style="font-size: 0.9rem; margin-top: 0.5rem; color: ${growth >= 0 ? '#10b981' : '#ef4444'};">
                        ${growth >= 0 ? '📈' : '📉'} ${growth}% QoQ
                    </div>
                </div>
                <div style="text-align: center; padding: 1rem; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border-color);">
                    <div style="font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem;">Average EPS</div>
                    <div style="font-size: 1.8rem; font-weight: 700; color: var(--text-primary);">$${avgEPS}</div>
                    <div style="font-size: 0.9rem; margin-top: 0.5rem; color: var(--text-muted);">
                        Over ${values.length} quarters
                    </div>
                </div>
                <div style="text-align: center; padding: 1rem; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border-color);">
                    <div style="font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem;">Range</div>
                    <div style="font-size: 1.8rem; font-weight: 700; color: var(--text-primary);">$${minEPS} - $${maxEPS}</div>
                    <div style="font-size: 0.9rem; margin-top: 0.5rem; color: var(--text-muted);">
                        Min / Max
                    </div>
                </div>
            `;
            
            document.getElementById('epsChartStats').innerHTML = statsHTML;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('epsChartModal'));
            modal.show();
        }

        // Draw sparklines on page load
        function drawSparklines() {
            console.log('📊 Drawing sparklines...');
            const stockDataEl = document.getElementById('stockData');
            if (!stockDataEl) {
                console.error('❌ stockData element not found');
                return;
            }

            const stockData = JSON.parse(stockDataEl.textContent);
            console.log(`Found ${stockData.length} stocks`);
            
            stockData.forEach(stock => {
                if (!stock.eps_history || !stock.eps_history.quarterly) {
                    console.log(`⚠️  ${stock.symbol}: No EPS history`);
                    return;
                }
                
                const svg = document.getElementById(`sparkline-${stock.symbol}`);
                if (!svg) {
                    console.log(`⚠️  ${stock.symbol}: SVG element not found`);
                    return;
                }
                console.log(`✓ Drawing sparkline for ${stock.symbol}`);
                
                const quarterly = stock.eps_history.quarterly;
                const sortedQuarters = Object.entries(quarterly).sort((a, b) => a[0].localeCompare(b[0]));
                const values = sortedQuarters.map(([_, eps]) => eps);
                
                if (values.length < 2) return;
                
                // Calculate dimensions
                const width = 100;
                const height = 30;
                const padding = 2;
                
                const maxVal = Math.max(...values);
                const minVal = Math.min(...values);
                const range = maxVal - minVal || 1;
                
                // Create points
                const points = values.map((val, i) => {
                    const x = padding + (i / (values.length - 1)) * (width - 2 * padding);
                    const y = height - padding - ((val - minVal) / range) * (height - 2 * padding);
                    return `${x},${y}`;
                }).join(' ');
                
                // Determine color based on trend
                const trend = values[values.length - 1] >= values[0];
                const color = trend ? '#10b981' : '#ef4444';
                
                // Draw line
                svg.innerHTML = `
                    <polyline
                        points="${points}"
                        fill="none"
                        stroke="${color}"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    />
                    ${values.map((val, i) => {
                        const x = padding + (i / (values.length - 1)) * (width - 2 * padding);
                        const y = height - padding - ((val - minVal) / range) * (height - 2 * padding);
                        return `<circle cx="${x}" cy="${y}" r="2" fill="${color}" />`;
                    }).join('')}
                `;
            });
        }

        // Call on page load
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                drawSparklines();
                console.log('✅ Sparklines drawn');
            }, 100);
        });
        
        // Also try on full load
        window.addEventListener('load', () => {
            setTimeout(() => {
                drawSparklines();
                console.log('✅ Sparklines redrawn on full load');
            }, 100);
        });
        
        // Initialize stats and theme on page load
        updateStats();
        initializeTheme();
    </script>
</body>
</html>